<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#667eea">
<meta name="description" content="Controle de pagamentos do projeto de energia solar com acompanhamento por parcelas.">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Pagamentos Energia Solar">
<link rel="apple-touch-icon" href="/controle-pagamentos-energia-solar/icons/icon-192.png">
<link rel="manifest" href="/controle-pagamentos-energia-solar/manifest.json">
    
<title>Controle de Pagamentos Energia Solar - Saltoleto</title>

<style>
:root {
    color-scheme: light;
    --bg: #f4f6fb;
    --card: #ffffff;
    --text: #0f172a;
    --muted: #64748b;
    --accent: #4f46e5;
    --accent-strong: #3730a3;
    --success: #16a34a;
    --warning: #f97316;
    --border: #e2e8f0;
    --shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
}

* {
    box-sizing: border-box;
    max-width: 100%;
}

body {
    margin: 0;
    padding: 24px;
    font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
    background: radial-gradient(circle at top, #eef2ff, var(--bg));
    color: var(--text);
}

.container {
    background: var(--card);
    border-radius: 18px;
    padding: 24px;
    max-width: 1200px;
    margin: 0 auto 40px;
    box-shadow: var(--shadow);
    border: 1px solid #eef2ff;
}

.header {
    display: flex;
    flex-direction: column;
    gap: 10px;
    text-align: center;
    margin-bottom: 24px;
}

.header h1 {
    margin: 0;
    font-size: clamp(22px, 3vw, 32px);
    font-weight: 700;
}

.header p {
    margin: 0;
    color: var(--muted);
    font-size: 14px;
}

/* ===== RESUMO ===== */
.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}

.stat {
    background: linear-gradient(135deg, #eef2ff, #ffffff);
    border: 1px solid #e0e7ff;
    padding: 14px;
    border-radius: 12px;
    text-align: left;
    display: grid;
    gap: 6px;
}

.stat h4 {
    margin: 0;
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

.stat span {
    font-size: 20px;
    font-weight: 700;
}

/* ===== TABELA / CARDS ===== */
table {
    width: 100%;
    border-collapse: collapse;
}

thead {
    display: none;
}

tr.card-parcela {
    display: block;
    background: #f8fafc;
    border: 1px solid var(--border);
    border-radius: 16px;
    margin-bottom: 16px;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
}

td {
    display: block;
    padding: 0;
}

/* ===== BLOCOS ===== */
.bloco {
    padding: 14px 16px;
    border-bottom: 1px solid #e2e8f0;
}

.bloco:last-child {
    border-bottom: none;
}

.bloco strong {
    display: block;
    font-size: 14px;
    margin-bottom: 6px;
}

.bloco .meta {
    font-size: 12px;
    color: var(--muted);
}

.valores div {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    color: var(--text);
    padding: 2px 0;
}

.valores .total {
    margin-top: 8px;
    font-weight: 700;
    border-top: 1px dashed #cbd5f5;
    padding-top: 6px;
    color: var(--accent-strong);
}

/* ===== INPUTS ===== */
select, input, button {
    width: 100%;
    padding: 10px 12px;
    margin-top: 8px;
    font-size: 14px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--text);
    transition: 0.2s ease;
}

select:focus, input:focus, button:focus {
    outline: 2px solid rgba(79, 70, 229, 0.2);
    border-color: var(--accent);
}

input[readonly] {
    background: #f1f5f9;
    cursor: not-allowed;
    color: var(--muted);
}

select[data-status="Pago"] {
    background: #dcfce7;
    border-color: #86efac;
}

select[data-status="Pendente"] {
    background: #fff7ed;
    border-color: #fdba74;
}

select:disabled {
    opacity: 0.8;
}

.btn-unlock {
    background: var(--warning);
    border: none;
    border-radius: 10px;
    cursor: pointer;
    color: #fff;
    font-weight: 600;
}

.btn-unlock:hover {
    filter: brightness(0.95);
}

/* ===== DESKTOP ===== */
@media (min-width: 900px) {

    thead {
        display: table-header-group;
        background: #eef2ff;
    }

    thead th {
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.08em;
        color: var(--muted);
        padding: 12px;
        text-align: center;
    }

    tr.card-parcela {
        display: table-row;
        background: #fff;
        box-shadow: none;
    }

    td {
        display: table-cell;
        padding: 12px;
        border: 1px solid var(--border);
        text-align: center;
        vertical-align: middle;
    }

    .bloco {
        border: none;
        padding: 0;
    }

    .valores div {
        display: block;
        font-size: 14px;
    }
}
</style>
</head>

<body>

<div class="container">
    <div class="header">
        <h1>üìä Controle de Pagamentos Energia Solar</h1>
        <p>Vis√£o financeira clara, no mesmo padr√£o do projeto de investimentos.</p>
    </div>

    <div class="stats" id="stats"></div>

    <table>
        <thead>
        <tr>
            <th>Parcela</th>
            <th>Valores</th>
            <th>Status</th>
            <th>Data</th>
            <th>A√ß√£o</th>
        </tr>
        </thead>
        <tbody id="tabela"></tbody>
    </table>
</div>

<!-- Firebase App -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>

<!-- Firestore -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Auth -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- Firebase Messaging-->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>

let swRegistration = null;

if ('serviceWorker' in navigator) {
  
 // üì¶ Cache / Offline
  const swUrl = new URL("service-worker.js", window.location.href);

  navigator.serviceWorker.register(swUrl).then(registration => {
    swRegistration = registration;
    console.log('Service Worker registrado:', registration.scope);
  }).catch(err => {
    console.error('Erro ao registrar SW:', err);
  });
}
    

firebase.initializeApp({
  apiKey: "AIzaSyCjs2EU9JuVHTxI0ZNIszAdH3mdF7obGnA",
  authDomain: "controle-pagamentos-3759d.firebaseapp.com",
  projectId: "controle-pagamentos-3759d",
  messagingSenderId: "219928011798",
  appId: "1:219928011798:web:7946650d61cf0bc2528137"
});

async function registrarNotificacao() {
  if (!("Notification" in window)) {
    alert("Este navegador n√£o suporta notifica√ß√µes");
    return;
  }

  const permission = await Notification.requestPermission();
  if (permission !== "granted") {
    alert("Permiss√£o de notifica√ß√£o negada");
    return;
  }

  if (!swRegistration) {
    alert("Service Worker ainda n√£o est√° pronto. Recarregue a p√°gina.");
    return;
  }

  const token = await messaging.getToken({
    vapidKey: "BFApPQ4kZRnpq8UedSKoxx_icTgJd_hcSztRh3aEa8cC3ZOS9Odwl-9DJygBRv7WcpHrB-1AY2_8nZtYn8JzBsk",
    serviceWorkerRegistration: swRegistration
  });

await db.collection("notificacoes").doc(token).set({
  token,
  criadoEm: firebase.firestore.FieldValue.serverTimestamp()
}, { merge: true });


  console.log("Token registrado:", token);
}
    


const auth = firebase.auth();
const db = firebase.firestore();
const messaging = firebase.messaging();


// ===== CONFIG =====
let senhaSistema = null;
const TOTAL_PARCELAS = 48;
const DATA_INICIO = new Date(2026, 1, 27);

const VALORES_BASE = {
    fernando: 300,
    vitor: 300,
    sebastiao: 200
};

const ACRESCIMO = 18;
const PARCELAS_COM_ACRESCIMO = 4;

let estadoPagamentos = [];

async function autenticarAnonimo() {
    try {
        await auth.signInAnonymously();
        console.log("Usu√°rio autenticado anonimamente");
    } catch (e) {
        alert("Erro ao autenticar: " + e.message);
    }
}
    

async function carregarSenha() {
    const doc = await db
        .collection("configuracoes")
        .doc("seguranca")
        .get();

    if (doc.exists) {
        senhaSistema = doc.data().senha;
    } else {
        alert("‚ö†Ô∏è Documento de seguran√ßa n√£o encontrado.");
    }
}
    

// ===== FUN√á√ïES =====
function valoresParcela(i) {
    const extra = i < PARCELAS_COM_ACRESCIMO ? ACRESCIMO : 0;
    const f = VALORES_BASE.fernando + extra;
    const v = VALORES_BASE.vitor + extra;
    const s = VALORES_BASE.sebastiao + extra;
    return { fernando: f, vitor: v, sebastiao: s, total: f + v + s };
}

function gerarTabela() {
    const tbody = document.getElementById("tabela");
    tbody.innerHTML = "";

    for (let i = 0; i < TOTAL_PARCELAS; i++) {
        const d = new Date(DATA_INICIO);
        d.setMonth(d.getMonth() + i);
        const v = valoresParcela(i);

        tbody.innerHTML += `
        <tr class="card-parcela">
            <td>
                <div class="bloco">
                    <strong>üìÖ Parcela ${String(i+1).padStart(2,"0")}/${TOTAL_PARCELAS}</strong>
                    <span class="meta">Vencimento: ${d.toLocaleDateString("pt-BR")}</span>
                </div>
            </td>

            <td>
                <div class="bloco valores">
                    <div>Fernando <span>R$ ${v.fernando.toFixed(2).replace(".",",")}</span></div>
                    <div>Vitor <span>R$ ${v.vitor.toFixed(2).replace(".",",")}</span></div>
                    <div>Sebasti√£o <span>R$ ${v.sebastiao.toFixed(2).replace(".",",")}</span></div>
                    <div class="total">Total <span>R$ ${v.total.toFixed(2).replace(".",",")}</span></div>
                </div>
            </td>

            <td>
                <div class="bloco">
                    <select data-i="${i}" onchange="pagar(${i}, this.value)">
                        <option>Pendente</option>
                        <option>Pago</option>
                    </select>
                </div>
            </td>

            <td>
                <div class="bloco">
                    <input type="date" data-i="${i}" readonly>
                </div>
            </td>

            <td>
                <div class="bloco">
                    <button class="btn-unlock" onclick="desbloquear(${i})">üîì Desbloquear</button>
                </div>
            </td>
        </tr>`;
    }
}

function iniciarListenerFirestore() {
    db.collection("pagamentos").doc("parcelas").onSnapshot(doc => {
        if (!doc.exists) return;
        estadoPagamentos = doc.data().dados || [];

        estadoPagamentos.forEach((p,i)=>{
            const s = document.querySelector(`select[data-i="${i}"]`);
            const d = document.querySelector(`input[data-i="${i}"]`);
            if(!s||!d) return;

            s.value = p.status;
            s.setAttribute("data-status", p.status);
            s.disabled = p.bloqueado;
            d.value = p.data || "";
        });

        atualizarResumo();
    });
}

async function salvar() {
    estadoPagamentos = [];
    for (let i = 0; i < TOTAL_PARCELAS; i++) {
        const s = document.querySelector(`select[data-i="${i}"]`);
        const d = document.querySelector(`input[data-i="${i}"]`);
        estadoPagamentos.push({
            status: s.value,
            data: d.value,
            bloqueado: s.disabled
        });
    }
    await db.collection("pagamentos").doc("parcelas").set({ dados: estadoPagamentos });
}

function pagar(i,status) {
    if(status==="Pago") {
        if (!senhaSistema) {
        alert("Senha ainda n√£o carregada.");
        return;
    }

    if (prompt("Senha:") !== senhaSistema) return;
        const s=document.querySelector(`select[data-i="${i}"]`);
        const d=document.querySelector(`input[data-i="${i}"]`);
        d.value=new Date().toISOString().split("T")[0];
        s.disabled=true;
        s.setAttribute("data-status","Pago");
        salvar();
    }
}

function desbloquear(i){
    if (!senhaSistema) {
        alert("Senha ainda n√£o carregada.");
        return;
    }

    if (prompt("Senha:") !== senhaSistema) return;
    
    const s=document.querySelector(`select[data-i="${i}"]`);
    const d=document.querySelector(`input[data-i="${i}"]`);
    s.disabled=false;
    s.value="Pendente";
    d.value="";
    s.setAttribute("data-status","Pendente");
    salvar();
}

function atualizarResumo(){
    let pagos=0,total=0;
    estadoPagamentos.forEach((p,i)=>{
        if(p.status==="Pago"){
            pagos++;
            total+=valoresParcela(i).total;
        }
    });

    document.getElementById("stats").innerHTML=`
        <div class="stat"><h4>Pagas</h4><span>${pagos}</span></div>
        <div class="stat"><h4>Pendentes</h4><span>${TOTAL_PARCELAS-pagos}</span></div>
        <div class="stat"><h4>Total Pago</h4><span>R$ ${total.toLocaleString("pt-BR",{minimumFractionDigits:2})}</span></div>
        <div class="stat"><h4>Progresso</h4><span>${Math.round((pagos/TOTAL_PARCELAS)*100)}%</span></div>
    `;
}


window.onload = async () => {
    await autenticarAnonimo();
    await carregarSenha(); 
    gerarTabela();
    iniciarListenerFirestore();
    registrarNotificacao();

};


</script>

</body>
</html>
