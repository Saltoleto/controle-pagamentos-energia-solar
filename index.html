<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle de Pagamentos</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 12px;
      background: #f4f6f8;
    }

    h2 {
      text-align: center;
      margin-bottom: 16px;
    }

    .container {
      max-width: 1000px;
      margin: auto;
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
    }

    .resumo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    .card {
      background: #eef2f6;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      font-size: 14px;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 720px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      font-size: 13px;
      text-align: center;
      white-space: nowrap;
    }

    th {
      background: #f0f0f0;
    }

    input[readonly] {
      background: #f3f3f3;
      border: 1px solid #ccc;
      padding: 4px;
      width: 100%;
      box-sizing: border-box;
    }

    select {
      padding: 4px;
    }

    .pago {
      background: #d4edda;
    }

    .pendente {
      background: #f8d7da;
    }

    @media (max-width: 600px) {
      h2 {
        font-size: 18px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Controle de Pagamentos</h2>

    <div class="resumo" id="resumoFinanceiro"></div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>ResponsÃ¡vel</th>
            <th>Parcela</th>
            <th>Valor (R$)</th>
            <th>Vencimento</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tabelaParcelas"></tbody>
      </table>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ðŸ”¥ CONFIG FIREBASE (SUBSTITUA)
    const firebaseConfig = {
    apiKey: "AIzaSyCjs2EU9JuVHTxI0ZNIszAdH3mdF7obGnA",
    authDomain: "controle-pagamentos-3759d.firebaseapp.com",
    projectId: "controle-pagamentos-3759d",
    storageBucket: "controle-pagamentos-3759d.firebasestorage.app",
    messagingSenderId: "219928011798",
    appId: "1:219928011798:web:7946650d61cf0bc2528137"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    await signInAnonymously(auth);

    let senhaSistema = null;
    let parcelas = [];

    const refParcelas = doc(db, "pagamentos", "parcelas");
    const refSenha = doc(db, "configuracoes", "seguranca");

    // ðŸ” CARREGA SENHA
    async function carregarSenha() {
      const snap = await getDoc(refSenha);
      if (snap.exists()) senhaSistema = snap.data().senha;
    }

    // ðŸ“¥ LISTENER
    function iniciarListener() {
      onSnapshot(refParcelas, snap => {
        if (snap.exists()) {
          parcelas = snap.data().dados;
          renderizar();
        }
      });
    }

    // ðŸ§® RESUMO
    function atualizarResumo() {
      const resumo = {};

      parcelas.forEach(p => {
        if (!resumo[p.nome]) {
          resumo[p.nome] = { total: 0, pago: 0 };
        }
        resumo[p.nome].total += p.valor;
        if (p.status === "Pago") resumo[p.nome].pago += p.valor;
      });

      const div = document.getElementById("resumoFinanceiro");
      div.innerHTML = "";

      Object.keys(resumo).forEach(nome => {
        const r = resumo[nome];
        div.innerHTML += `
          <div class="card">
            <strong>${nome}</strong><br>
            Total: R$ ${r.total.toFixed(2)}<br>
            Pago: R$ ${r.pago.toFixed(2)}<br>
            Aberto: R$ ${(r.total - r.pago).toFixed(2)}
          </div>
        `;
      });
    }

    // ðŸ–¥ï¸ TABELA
    function renderizar() {
      const tbody = document.getElementById("tabelaParcelas");
      tbody.innerHTML = "";

      parcelas.forEach((p, i) => {
        const tr = document.createElement("tr");
        tr.className = p.status === "Pago" ? "pago" : "pendente";

        tr.innerHTML = `
          <td>${p.nome}</td>
          <td>${p.parcela}</td>
          <td>${p.valor.toFixed(2)}</td>
          <td><input type="date" value="${p.data}" readonly></td>
          <td>
            <select ${p.bloqueado ? "disabled" : ""}>
              <option ${p.status === "Pendente" ? "selected" : ""}>Pendente</option>
              <option ${p.status === "Pago" ? "selected" : ""}>Pago</option>
            </select>
          </td>
        `;

        const select = tr.querySelector("select");
        select.onchange = async () => {
          if (prompt("Senha:") !== senhaSistema) {
            select.value = p.status;
            return;
          }

          p.status = "Pago";
          p.bloqueado = true;

          await setDoc(refParcelas, { dados: parcelas });
        };

        tbody.appendChild(tr);
      });

      atualizarResumo();
    }

    // ðŸš€ START
    await carregarSenha();
    iniciarListener();
  </script>
</body>
</html>
