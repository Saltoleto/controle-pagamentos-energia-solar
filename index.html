<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Pagamentos Energia Solar - Saltoleto</title>

<style>
* {
    box-sizing: border-box;
    max-width: 100%;
}

body {
    margin: 0;
    padding: 10px;
    font-family: Arial, sans-serif;
    background: #f2f2f2;
}

.container {
    background: #fff;
    border-radius: 8px;
    padding: 12px;
    max-width: 1200px;
    margin: auto;
}

h2 {
    text-align: center;
    margin-bottom: 10px;
}

/* ===== RESUMO ===== */
.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 8px;
    margin-bottom: 12px;
}

.stat {
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    padding: 8px;
    border-radius: 4px;
    text-align: center;
}

.stat h4 {
    margin: 0;
    font-size: 12px;
    color: #666;
}

.stat span {
    font-size: 18px;
    font-weight: bold;
}

/* ===== TABELA / CARDS ===== */
table {
    width: 100%;
    border-collapse: collapse;
}

thead {
    display: none;
}

tr.card-parcela {
    display: block;
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 12px;
}

td {
    display: block;
    padding: 0;
}

/* ===== BLOCOS ===== */
.bloco {
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.bloco:last-child {
    border-bottom: none;
}

.valores div {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
}

.valores .total {
    margin-top: 6px;
    font-weight: bold;
    border-top: 1px dashed #ccc;
    padding-top: 4px;
}

/* ===== INPUTS ===== */
select, input, button {
    width: 100%;
    padding: 8px;
    margin-top: 6px;
    font-size: 14px;
}

input[readonly] {
    background: #e9ecef;
    cursor: not-allowed;
}

select[data-status="Pago"] {
    background: #d4edda;
}

select[data-status="Pendente"] {
    background: #f8d7da;
}

select:disabled {
    opacity: 0.7;
}

.btn-unlock {
    background: #ffc107;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

/* ===== DESKTOP ===== */
@media (min-width: 900px) {

    thead {
        display: table-header-group;
    }

    tr.card-parcela {
        display: table-row;
        background: #fff;
    }

    td {
        display: table-cell;
        padding: 8px;
        border: 1px solid #ddd;
        text-align: center;
        vertical-align: middle;
    }

    .bloco {
        border: none;
        padding: 0;
    }

    .valores div {
        display: block;
        font-size: 14px;
    }
}
</style>
</head>

<body>

<div class="container">
    <h2>üìä Controle de Pagamentos Energia Solar - Saltoleto</h2>

    <div class="stats" id="stats"></div>

    <table>
        <thead>
        <tr>
            <th>Parcela</th>
            <th>Vencimento</th>
            <th>Valores</th>
            <th>Status</th>
            <th>Data</th>
            <th>A√ß√£o</th>
        </tr>
        </thead>
        <tbody id="tabela"></tbody>
    </table>
</div>

<!-- Firebase App -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>

<!-- Firestore -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Auth -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- Firebase Messaging-->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>

let swRegistration = null;

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register(
    '/controle-pagamentos-energia-solar/firebase-messaging-sw.js'
  ).then(registration => {
    swRegistration = registration;
    console.log('Service Worker registrado:', registration.scope);
  }).catch(err => {
    console.error('Erro ao registrar SW:', err);
  });
}
    

firebase.initializeApp({
  apiKey: "AIzaSyCjs2EU9JuVHTxI0ZNIszAdH3mdF7obGnA",
  authDomain: "controle-pagamentos-3759d.firebaseapp.com",
  projectId: "controle-pagamentos-3759d",
  messagingSenderId: "219928011798",
  appId: "1:219928011798:web:7946650d61cf0bc2528137"
});

async function registrarNotificacao() {
  if (!("Notification" in window)) {
    alert("Este navegador n√£o suporta notifica√ß√µes");
    return;
  }

  const permission = await Notification.requestPermission();
  if (permission !== "granted") {
    alert("Permiss√£o de notifica√ß√£o negada");
    return;
  }

  if (!swRegistration) {
    alert("Service Worker ainda n√£o est√° pronto. Recarregue a p√°gina.");
    return;
  }

  const token = await messaging.getToken({
    vapidKey: "BFApPQ4kZRnpq8UedSKoxx_icTgJd_hcSztRh3aEa8cC3ZOS9Odwl-9DJygBRv7WcpHrB-1AY2_8nZtYn8JzBsk",
    serviceWorkerRegistration: swRegistration
  });

  await db.collection("notificacoes").doc(token).set({
    token,
    criadoEm: firebase.firestore.FieldValue.serverTimestamp()
  });

  console.log("Token registrado:", token);
}
    


const auth = firebase.auth();
const db = firebase.firestore();
const messaging = firebase.messaging();


// ===== CONFIG =====
let senhaSistema = null;
const TOTAL_PARCELAS = 48;
const DATA_INICIO = new Date(2026, 1, 27);

const VALORES_BASE = {
    fernando: 300,
    vitor: 300,
    sebastiao: 200
};

const ACRESCIMO = 18;
const PARCELAS_COM_ACRESCIMO = 4;

let estadoPagamentos = [];

async function autenticarAnonimo() {
    try {
        await auth.signInAnonymously();
        console.log("Usu√°rio autenticado anonimamente");
    } catch (e) {
        alert("Erro ao autenticar: " + e.message);
    }
}
    

async function carregarSenha() {
    const doc = await db
        .collection("configuracoes")
        .doc("seguranca")
        .get();

    if (doc.exists) {
        senhaSistema = doc.data().senha;
    } else {
        alert("‚ö†Ô∏è Documento de seguran√ßa n√£o encontrado.");
    }
}

// ===== NOTIFICA√á√ïES (FCM) =====
async function registrarNotificacao() {
    try {
        // Solicita permiss√£o
        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
            console.log("Permiss√£o de notifica√ß√£o negada");
            return;
        }

        // Obt√©m o token do dispositivo
        const token = await messaging.getToken({
            vapidKey: "BP1_U06Nws615JSm4XqDpHLrsAN_Y_UEKe62PkmmreAQnmo9YiT8ZAQG7yQoF__kYMqrqbhw3jS1pIZUk6KO29Y"
        });

        if (!token) return;

        console.log("Token FCM:", token);

        // Salva token no Firestore
        await db.collection("notificacoes").doc(token).set({
            token,
            criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
            userId: auth.currentUser.uid
        });

    } catch (e) {
        console.error("Erro ao registrar notifica√ß√£o:", e);
    }
}

    

// ===== FUN√á√ïES =====
function valoresParcela(i) {
    const extra = i < PARCELAS_COM_ACRESCIMO ? ACRESCIMO : 0;
    const f = VALORES_BASE.fernando + extra;
    const v = VALORES_BASE.vitor + extra;
    const s = VALORES_BASE.sebastiao + extra;
    return { fernando: f, vitor: v, sebastiao: s, total: f + v + s };
}

function gerarTabela() {
    const tbody = document.getElementById("tabela");
    tbody.innerHTML = "";

    for (let i = 0; i < TOTAL_PARCELAS; i++) {
        const d = new Date(DATA_INICIO);
        d.setMonth(d.getMonth() + i);
        const v = valoresParcela(i);

        tbody.innerHTML += `
        <tr class="card-parcela">
            <td>
                <div class="bloco">
                    <strong>üìÖ Parcela ${String(i+1).padStart(2,"0")}/${TOTAL_PARCELAS}</strong>
                    Vencimento: ${d.toLocaleDateString("pt-BR")}
                </div>
            </td>

            <td>
                <div class="bloco valores">
                    <div>Fernando <span>R$ ${v.fernando.toFixed(2).replace(".",",")}</span></div>
                    <div>Vitor <span>R$ ${v.vitor.toFixed(2).replace(".",",")}</span></div>
                    <div>Sebasti√£o <span>R$ ${v.sebastiao.toFixed(2).replace(".",",")}</span></div>
                    <div class="total">Total <span>R$ ${v.total.toFixed(2).replace(".",",")}</span></div>
                </div>
            </td>

            <td>
                <div class="bloco">
                    <select data-i="${i}" onchange="pagar(${i}, this.value)">
                        <option>Pendente</option>
                        <option>Pago</option>
                    </select>
                </div>
            </td>

            <td>
                <div class="bloco">
                    <input type="date" data-i="${i}" readonly>
                </div>
            </td>

            <td>
                <div class="bloco">
                    <button class="btn-unlock" onclick="desbloquear(${i})">üîì Desbloquear</button>
                </div>
            </td>
        </tr>`;
    }
}

function iniciarListenerFirestore() {
    db.collection("pagamentos").doc("parcelas").onSnapshot(doc => {
        if (!doc.exists) return;
        estadoPagamentos = doc.data().dados || [];

        estadoPagamentos.forEach((p,i)=>{
            const s = document.querySelector(`select[data-i="${i}"]`);
            const d = document.querySelector(`input[data-i="${i}"]`);
            if(!s||!d) return;

            s.value = p.status;
            s.setAttribute("data-status", p.status);
            s.disabled = p.bloqueado;
            d.value = p.data || "";
        });

        atualizarResumo();
    });
}

async function salvar() {
    estadoPagamentos = [];
    for (let i = 0; i < TOTAL_PARCELAS; i++) {
        const s = document.querySelector(`select[data-i="${i}"]`);
        const d = document.querySelector(`input[data-i="${i}"]`);
        estadoPagamentos.push({
            status: s.value,
            data: d.value,
            bloqueado: s.disabled
        });
    }
    await db.collection("pagamentos").doc("parcelas").set({ dados: estadoPagamentos });
}

function pagar(i,status) {
    if(status==="Pago") {
        if (!senhaSistema) {
        alert("Senha ainda n√£o carregada.");
        return;
    }

    if (prompt("Senha:") !== senhaSistema) return;
        const s=document.querySelector(`select[data-i="${i}"]`);
        const d=document.querySelector(`input[data-i="${i}"]`);
        d.value=new Date().toISOString().split("T")[0];
        s.disabled=true;
        s.setAttribute("data-status","Pago");
        salvar();
    }
}

function desbloquear(i){
    if (!senhaSistema) {
        alert("Senha ainda n√£o carregada.");
        return;
    }

    if (prompt("Senha:") !== senhaSistema) return;
    
    const s=document.querySelector(`select[data-i="${i}"]`);
    const d=document.querySelector(`input[data-i="${i}"]`);
    s.disabled=false;
    s.value="Pendente";
    d.value="";
    s.setAttribute("data-status","Pendente");
    salvar();
}

function atualizarResumo(){
    let pagos=0,total=0;
    estadoPagamentos.forEach((p,i)=>{
        if(p.status==="Pago"){
            pagos++;
            total+=valoresParcela(i).total;
        }
    });

    document.getElementById("stats").innerHTML=`
        <div class="stat"><h4>Pagas</h4><span>${pagos}</span></div>
        <div class="stat"><h4>Pendentes</h4><span>${TOTAL_PARCELAS-pagos}</span></div>
        <div class="stat"><h4>Total Pago</h4><span>R$ ${total.toLocaleString("pt-BR",{minimumFractionDigits:2})}</span></div>
        <div class="stat"><h4>Progresso</h4><span>${Math.round((pagos/TOTAL_PARCELAS)*100)}%</span></div>
    `;
}

// Notifica√ß√£o com app aberto
messaging.onMessage(payload => {
    console.log("Mensagem recebida:", payload);

    if (payload.notification) {
        alert(
            payload.notification.title + "\n" +
            payload.notification.body
        );
    }
});


window.onload = async () => {
    await autenticarAnonimo();
    await carregarSenha(); 
    gerarTabela();
    iniciarListenerFirestore();
    registrarNotificacao();

};


</script>

</body>
</html>
